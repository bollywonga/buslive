<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bus Live Tracker</title>
  <link rel="icon" href="data:," />
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <style>
    :root{--glass: rgba(255,255,255,0.12);--glass-strong: rgba(255,255,255,0.16)}
    html,body{height:100%;margin:0;font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    body{
      display:flex;flex-direction:column;min-height:100vh;background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);color:#fff;
    }
    header{
      padding:18px 22px;font-weight:700;font-size:22px;text-align:center;background:rgba(0,0,0,0.25);backdrop-filter:blur(4px);
      display:flex;align-items:center;gap:10px;justify-content:center;letter-spacing:0.6px;
    }

    #map {
      flex:1;min-height:420px;border-radius:16px;margin:18px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,0.45);
      position:relative;
    }

    /* Status banner for passengers */
    #status-banner {
      position:absolute;top:20px;left:50%;transform:translateX(-50%);z-index:1000;
      background:linear-gradient(180deg, rgba(0,0,0,0.7), rgba(0,0,0,0.85));
      padding:12px 20px;border-radius:25px;backdrop-filter:blur(8px);
      display:none;align-items:center;gap:10px;font-size:14px;font-weight:600;
      box-shadow:0 4px 20px rgba(0,0,0,0.4);
    }
    #status-banner.show {display:flex}
    .status-dot {
      width:8px;height:8px;border-radius:50%;background:#00ff88;
      animation:pulse 2s ease-in-out infinite;
    }
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}

    #loader{
      position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:56px;height:56px;border-radius:50%;
      border:6px solid rgba(255,255,255,0.2);border-top-color:#fff;animation:spin 0.9s linear infinite;z-index:1000;
    }
    @keyframes spin{0%{transform:translate(-50%,-50%) rotate(0)}100%{transform:translate(-50%,-50%) rotate(360deg)}}

    #message {
      position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
      background:linear-gradient(180deg, rgba(0,0,0,0.45), rgba(0,0,0,0.55));
      padding:22px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.6);max-width:90%;text-align:center;z-index:1001;
      display:none;backdrop-filter:blur(10px);
    }
    #message.show{display:block}
    #message p{margin:0 0 16px;font-size:15px;line-height:1.5}
    .msg-btn{border:none;padding:10px 16px;border-radius:10px;font-weight:600;cursor:pointer;font-size:14px}

    #controls{
      position:fixed;left:50%;transform:translateX(-50%);bottom:26px;display:flex;gap:12px;padding:10px 18px;border-radius:999px;
      background:linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));backdrop-filter:blur(8px);z-index:999;
      box-shadow:0 8px 30px rgba(0,0,0,0.45);
    }
    button{cursor:pointer;border:none;padding:12px 18px;border-radius:28px;font-weight:700;font-size:14px;transition:transform 0.2s}
    button:hover{transform:scale(1.05)}
    button:active{transform:scale(0.98)}
    .btn-primary{background:linear-gradient(90deg,#00c6ff,#0078ff);color:#fff}
    .btn-danger{background:linear-gradient(90deg,#ff416c,#ff4b2b);color:#fff}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.3);color:#fff}

    .hidden{display:none !important}
    footer{padding:12px;text-align:center;font-size:13px;background:rgba(0,0,0,0.12)}
    
    /* Custom bus marker */
    .bus-marker {
      background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      border: 3px solid white;
    }
    
    @media (max-width:480px){
      header{font-size:18px;padding:14px}
      #controls{gap:8px;padding:8px 12px;bottom:16px}
      button{padding:10px 14px;font-size:13px}
      #map{margin:12px;min-height:380px}
      #status-banner{font-size:12px;padding:10px 16px}
    }
  </style>
</head>
<body>
  <header>ðŸšŒ <span>Bus Live Tracker</span></header>

  <div id="map">
    <div id="loader"></div>
    <div id="status-banner">
      <span class="status-dot"></span>
      <span id="status-text">Waiting for driver...</span>
    </div>
    <div id="message">
      <p id="message-text"></p>
      <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
        <button id="retryBtn" class="msg-btn btn-primary">Try Again</button>
        <button id="closeBtn" class="msg-btn btn-ghost">Close</button>
      </div>
    </div>
  </div>

  <div id="controls">
    <button id="startBtn" class="btn-primary">Start Sharing</button>
    <button id="shareBtn" class="btn-ghost hidden">Share Link</button>
    <button id="stopBtn" class="btn-danger hidden">Stop Sharing</button>
  </div>

  <footer>Â© 2025 Bus Tracker | Simple & Secure | Powered by OpenStreetMap</footer>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAnDRhdEvaZTPlJr9rmmB7VLn8xUh_E22U",
      authDomain: "buslive-d984a.firebaseapp.com",
      databaseURL: "https://buslive-d984a-default-rtdb.firebaseio.com",
      projectId: "buslive-d984a",
      storageBucket: "buslive-d984a.firebasestorage.app",
      messagingSenderId: "653217528392",
      appId: "1:653217528392:web:da87e353dba5a67c59367d",
      measurementId: "G-RN7XG4R2KF"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // DOM
    const loader = document.getElementById('loader');
    const controls = document.getElementById('controls');
    const startBtn = document.getElementById('startBtn');
    const shareBtn = document.getElementById('shareBtn');
    const stopBtn = document.getElementById('stopBtn');
    const messageBox = document.getElementById('message');
    const messageText = document.getElementById('message-text');
    const retryBtn = document.getElementById('retryBtn');
    const closeBtn = document.getElementById('closeBtn');
    const statusBanner = document.getElementById('status-banner');
    const statusText = document.getElementById('status-text');

    // State
    let map = null;
    let marker = null;
    let watchId = null;
    let trackingId = null;

    const urlParams = new URLSearchParams(window.location.search);
    const viewId = urlParams.get('track');
    const DEFAULT_LAT = 23.588;
    const DEFAULT_LNG = 58.382;

    // Create custom bus icon
    const busIcon = L.divIcon({
      className: 'bus-marker',
      html: 'ðŸšŒ',
      iconSize: [40, 40],
      iconAnchor: [20, 20]
    });

    // Initialize Leaflet map
    function createMap(lat, lng) {
      if (!map) {
        try {
          map = L.map('map', {
            center: [lat, lng],
            zoom: 14,
            zoomControl: true
          });

          // Add OpenStreetMap tiles
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors',
            maxZoom: 19
          }).addTo(map);

          // Add bus marker
          marker = L.marker([lat, lng], { icon: busIcon }).addTo(map);
          marker.bindPopup('ðŸšŒ Bus Location');

          loader.style.display = 'none';
        } catch (e) {
          console.error('Map creation error:', e);
          loader.style.display = 'none';
          showMessage('Map failed to load. Please refresh the page.');
        }
      } else {
        map.setView([lat, lng], map.getZoom());
        marker.setLatLng([lat, lng]);
      }
    }

    function updateLocation(lat, lng) {
      if (!map) {
        createMap(lat, lng);
      } else {
        marker.setLatLng([lat, lng]);
        map.panTo([lat, lng]);
      }
    }

    function showMessage(text) {
      messageText.textContent = text;
      messageBox.classList.add('show');
    }

    function hideMessage() {
      messageBox.classList.remove('show');
    }

    // Initialize map immediately
    if (viewId) {
      // Passenger mode
      statusBanner.classList.add('show');
      controls.style.display = 'none';
      loader.style.display = 'block';
      
      let firstUpdate = true;
      
      onValue(ref(db, `tracks/${viewId}`), (snapshot) => {
        const data = snapshot.val();
        
        if (data && data.lat !== undefined && data.lng !== undefined) {
          const { lat, lng } = data;
          
          if (firstUpdate) {
            loader.style.display = 'none';
            statusText.textContent = 'Bus is live';
            firstUpdate = false;
          }
          
          updateLocation(lat, lng);
        } else {
          loader.style.display = 'none';
          statusBanner.classList.remove('show');
          showMessage('Tracking has ended or the link is invalid. Please ask the driver for a new link.');
        }
      }, (err) => {
        console.error('Firebase error:', err);
        loader.style.display = 'none';
        statusBanner.classList.remove('show');
        showMessage('Unable to connect to tracking. Please check your internet connection and try refreshing the page.');
      });
    } else {
      // Driver mode - create map with default location
      createMap(DEFAULT_LAT, DEFAULT_LNG);
    }

    // Driver mode controls
    if (!viewId) {
      startBtn.addEventListener('click', () => {
        trackingId = Math.random().toString(36).slice(2, 10);
        
        startBtn.classList.add('hidden');
        shareBtn.classList.remove('hidden');
        stopBtn.classList.remove('hidden');

        if (!('geolocation' in navigator)) {
          showMessage('Your device does not support location services. Please use a different device.');
          return;
        }

        loader.style.display = 'block';

        watchId = navigator.geolocation.watchPosition(
          async (pos) => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;

            updateLocation(lat, lng);
            loader.style.display = 'none';

            try {
              await set(ref(db, `tracks/${trackingId}`), { 
                lat, 
                lng, 
                ts: Date.now() 
              });
            } catch (e) {
              console.error('Firebase write error:', e);
            }
          },
          (err) => {
            loader.style.display = 'none';
            console.error('Geolocation error:', err);
            
            let errorMsg = 'Unable to access your location. ';
            
            if (err.code === 1) {
              errorMsg += 'Please allow location permission in your browser settings and try again.';
            } else if (err.code === 2) {
              errorMsg += 'Make sure GPS is enabled and you have a clear view of the sky.';
            } else {
              errorMsg += 'Please check your device settings and try again.';
            }
            
            showMessage(errorMsg);
          },
          {
            enableHighAccuracy: true,
            maximumAge: 1000,
            timeout: 20000
          }
        );
      });

      shareBtn.addEventListener('click', async () => {
        const link = `${window.location.origin}${window.location.pathname}?track=${trackingId}`;
        
        try {
          if (navigator.share) {
            await navigator.share({
              title: 'Track My Bus',
              text: 'Follow my live location',
              url: link
            });
          } else if (navigator.clipboard) {
            await navigator.clipboard.writeText(link);
            alert('Link copied! Share it with passengers:\n\n' + link);
          } else {
            prompt('Copy this link:', link);
          }
        } catch (e) {
          if (e.name !== 'AbortError') {
            prompt('Copy this link:', link);
          }
        }
      });

      stopBtn.addEventListener('click', async () => {
        if (watchId) {
          navigator.geolocation.clearWatch(watchId);
          watchId = null;
        }
        
        if (trackingId) {
          try {
            await remove(ref(db, `tracks/${trackingId}`));
          } catch (e) {
            console.warn('Error removing track:', e);
          }
          trackingId = null;
        }
        
        alert('Location sharing stopped.');
        location.reload();
      });

      retryBtn.addEventListener('click', () => {
        hideMessage();
        location.reload();
      });

      closeBtn.addEventListener('click', () => {
        hideMessage();
      });
    } else {
      closeBtn.addEventListener('click', () => {
        hideMessage();
      });
    }
  </script>
</body>
</html>
